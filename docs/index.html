<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Srcweave Literate Mode</title>
<link rel="stylesheet" href="google-code-prettify/prettify.css">
<link rel="stylesheet" href="styles/prettify-theme.css">
<script defer src="google-code-prettify/prettify.js"></script>
<script defer src="google-code-prettify/lang-el.js"></script>
<script defer src="google-code-prettify/run_prettify.js"></script>
<link rel="stylesheet" href="styles/main.css">
</head>

<!-- Generated by srcweave https://github.com/justinmeiners/srcweave -->
<h1>Srcweave Literate Mode<a id="c0"></a></h1>


<p>By: <a href="https://owoga.com"><strong>Eric Ihli</strong></a></p>

<p>View the final code and other resources in the <a href="https://github.com/eihli/lit-mode">GitHub repo</a>.</p>

<p>I&rsquo;m going to follow the <a href="https://www.emacswiki.org/emacs/ModeTutorial">ModeTutorial</a> from the Emacs Wiki to create mode for <a href="https://github.com/justinmeiners/srcweave">srcweave</a>.</p>

<ol><li><a href="#s0:0">The entry function</a></li><li><a href="#s0:1">Preamble</a></li></ol>


<blockquote><p><strong>Note:</strong> This tutorial is a <a href="https://en.wikipedia.org/wiki/Literate_programming">literate program</a>.
This means you are reading the source code right now!
Each piece of code will be shown and explained thoroughly, so you can be sure nothing is left out.
The final code was created by <a href="https://github.com/justinmeiners/srcweave">&ldquo;tangling&rdquo;</a> the blocks of code together.</p></blockquote>

<p>First, we define some variables that all modes should define. ‘lit-mode-hook’ allows the user to run their own code when your mode is run.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="hooks-block-1" href="#hooks-block-1">Hooks</a></em></strong></span>
<pre class="prettyprint"><code class="">(defvar lit-mode-mode-hook nil)
</code></pre>
<p class="block-usages"><small>Used by <a href="#-lit-mode.el-block-11" title="/lit-mode.el">1</a> </small></p></div>


<p>Now we create a keymap. This map, here called ‘lit-mode-map’, allows both you and users to define their own keymaps. The keymap is immediately set to a default keymap. Then, using ‘define-key’, we insert an example keybinding into the keymap, which maps the ‘newline-and-indent’ function to Control-j (which is actually the default binding for this function, but is included anyway as an example). Of course, you may define as many keybindings as you wish.</p>

<p>If your keymap will have very few entries, then you may want to consider ‘make-sparse-keymap’ rather than ‘make-keymap’.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="keymap-block-3" href="#keymap-block-3">Keymap</a></em></strong></span>
<pre class="prettyprint"><code class="">(defvar lit-mode-map
  (let ((map (make-keymap)))
    (define-key map "\C-j" 'newline-and-indent)
    map)
  "Keymap for Srcweave Literate major mode.")
</code></pre>
<p class="block-usages"><small>Used by <a href="#-lit-mode.el-block-11" title="/lit-mode.el">1</a> </small></p></div>


<p>Here, we append a definition to ‘auto-mode-alist’. This tells emacs that when a buffer with a name ending with .wpd is opened, then wpdl-mode should be started in that buffer. Some modes leave this step to the user.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="autoload-block-5" href="#autoload-block-5">Autoload</a></em></strong></span>
<pre class="prettyprint"><code class="">;;;###autoload
(add-to-list 'auto-mode-alist '("\\.lit\\'" . lit-mode))
</code></pre>
<p class="block-usages"><small>Used by <a href="#-lit-mode.el-block-11" title="/lit-mode.el">1</a> </small></p></div>


<p>Next let&rsquo;s define a minimal set of keywords for emacs to highlight. A ‘font-lock-keyword’ variable is a list of keywords to highlight. There are many ways to specify this list. I&rsquo;ll use the form (matcher . facename). With this form, I&rsquo;ll specify a pattern to match, and then a face name to use for the actual highlighting.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="syntax-highlighting-block-7" href="#syntax-highlighting-block-7">Syntax highlighting</a></em></strong></span>
<pre class="prettyprint"><code class="">(defconst lit-font-lock-code-blocks
  (list
   '("^\\(---\\)". font-lock-doc-markup-face)
   '("^---[\t ]*\\([^\-\n/]+\\)" . (1 font-lock-constant-face))
   '("@{\\([^}]+\\)}" . (1 font-lock-constant-face)))
  "Minimal highlighting expressions for lit mode.")
</code></pre>
<p class="block-usages"><small>Used by <a href="#-lit-mode.el-block-11" title="/lit-mode.el">1</a> </small></p></div>


<p>There are three elements to my list: the first element matches srcweave code block syntax, <code>---</code>.
The second element matches the declaration of the reference name (the name used to include the contents of one source code block into another).
And the third matches the <em>use</em> of the reference name (e.g. <code>@{SomeCodeBlock}</code>).</p>

<p>I&rsquo;m going to borrow some existing faces with names close-enough to what I want.
For the open and close of a code block, I&rsquo;m going to use <code>font-lock-doc-markup-face</code>.
For the code block reference names, I&rsquo;ll use <code>font-lock-constant-face</code>.</p>

<p>For my keyword list, I’ve selected those WPDL keywords which would benefit most from being highlighted: keywords that delimit blocks of information.
One may notice that the regexp used to specify these keywords is optimized.
I did not have to do this by hand.
Emacs provides the ‘regexp-opt’ function to save you from the tedious work of creating complicated regexps.
‘regexp-opt’ takes a list of strings and an additional optional argument.
This optional argument controls whether or not we want to wrap the entire regexp in parens.
In our case, we do.
For example, the following expression:</p>

<h2>1. The entry function<a id="s0:0"></a></h2>


<p>Finally, we will create the function that will be called by Emacs when the mode is started.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="entry-function-block-9" href="#entry-function-block-9">Entry function</a></em></strong></span>
<pre class="prettyprint"><code class="">(defun lit-mode ()
  "Major mode for editing srcweave literate files."
  (interactive)
  (kill-all-local-variables)
  (use-local-map lit-mode-map)
  (set (make-local-variable 'font-lock-defaults) '(lit-font-lock-code-blocks))
  (setq major-mode 'lit-mode)
  (setq mode-name "Lit")
  (run-hooks 'lit-mode-hook))
</code></pre>
<p class="block-usages"><small>Used by <a href="#-lit-mode.el-block-11" title="/lit-mode.el">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="-lit-mode.el-block-11" href="#-lit-mode.el-block-11">/lit-mode.el</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode" title=""><a href="#preamble-block-13">@{Preamble}</a></em>
<em class="block-link nocode" title=""><a href="#hooks-block-1">@{Hooks}</a></em>
<em class="block-link nocode" title=""><a href="#keymap-block-3">@{Keymap}</a></em>
<em class="block-link nocode" title=""><a href="#autoload-block-5">@{Autoload}</a></em>
<em class="block-link nocode" title=""><a href="#syntax-highlighting-block-7">@{Syntax highlighting}</a></em>
<em class="block-link nocode" title=""><a href="#entry-function-block-9">@{Entry function}</a></em>

(provide 'lit-mode)
<em class="block-link nocode" title=""><a href="#postamble-block-15">@{Postamble}</a></em>
</code></pre>
</div>




<h2>2. Preamble<a id="s0:1"></a></h2>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="preamble-block-13" href="#preamble-block-13">Preamble</a></em></strong></span>
<pre class="prettyprint"><code class="">;;; lit-mode.el --- Description -*- lexical-binding: t; -*-
;;
;; Copyright (C) 2022 Eric Ihli
;;
;; Author: Eric Ihli &lt;eihli@owoga.com&gt;
;; Maintainer: Eric Ihli &lt;eihli@owoga.com&gt;
;; Created: August 02, 2022
;; Modified: August 02, 2022
;; Version: 0.0.1
;; Keywords: abbrev bib c calendar comm convenience data docs emulations extensions faces files frames games hardware help hypermedia i18n internal languages lisp local maint mail matching mouse multimedia news outlines processes terminals tex tools unix vc wp
;; Homepage: https://github.com/eihli/foo
;; Package-Requires: ((emacs "24.3"))
;;
;; This file is not part of GNU Emacs.
;;
;;; Commentary:
;;
;;  Description
;;
;;; Code:
</code></pre>
<p class="block-usages"><small>Used by <a href="#-lit-mode.el-block-11" title="/lit-mode.el">1</a> </small></p></div>


<h3>Postamble</h3>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="postamble-block-15" href="#postamble-block-15">Postamble</a></em></strong></span>
<pre class="prettyprint"><code class="">;;; lit-mode.el ends here
</code></pre>
<p class="block-usages"><small>Used by <a href="#-lit-mode.el-block-11" title="/lit-mode.el">1</a> </small></p></div>

</body>
</html>
